<!-- Powered by BMAD™ Core -->

# Story 3.2: Chat UX Polish and Streaming

## Status
Done

## Story
**As a** trip owner using BorderBuddy chat,
**I want** a responsive chat experience with typing indication, streamed replies, and clear retry handling,
**so that** I can see progress quickly, understand failures, and recover without losing my message.

## Acceptance Criteria
1. Streaming: Assistant replies stream partial content when supported; otherwise fall back to batched responses. Streaming must gracefully end with a final persisted assistant message and include the standard disclaimer.
2. Typing Indicator: While an assistant reply is in progress, a visible typing indicator shows; it clears on success or failure. Indicator updates are accessible (ARIA live region) and non-blocking.
3. Retry Handling: On API/LLM failure, the chat shows a concise error and a Retry action that re-attempts the assistant reply without duplicating the user message. Use exponential backoff at the service or client per architecture guidance.
4. Disclaimer: Assistant messages display the standard informational disclaimer consistently.

Source: docs/stories/epic-3-borderbuddy-chat-and-places.md

## Tasks / Subtasks
- [x] API streaming support (AC: 1, 4)
  - [x] Enhance `POST /api/trips/{tripId}/borderbuddy/chat/messages` to support streaming mode (e.g., `Accept: text/event-stream` or `?stream=1`) while preserving batch mode [Source: architecture/api-design-and-integration.md#5-chat]
  - [x] Implement streaming in `ChatService.reply(...)` with provider token events → emit chunks; on completion, persist full assistant message and include disclaimer [Source: architecture/external-api-integration.md#prompting]
  - [x] Ensure non-streamed envelope remains `{ success, data }` and streamed events follow a simple `{ type, data }` contract (`start|delta|complete|error`) [Source: architecture/api-design-and-integration.md#api-integration-strategy]

- [x] Typing indicator UX (AC: 2)
  - [x] Update Chat UI to show a typing indicator when a reply is in progress; remove it on `complete|error` [Source: architecture/component-architecture.md#frontend-composition]
  - [x] Add ARIA live region for incremental updates; ensure focus management doesn’t trap keyboard users [Source: architecture/non-functional-nfr.md]

- [x] Retry and error handling (AC: 3)
  - [x] Surface concise error states in Chat UI with a Retry button; preserve the user message without duplication [Source: architecture/external-api-integration.md#safety-reliability-and-cost]
  - [x] Implement exponential backoff and timeout controls around OpenAI calls; map failures to consistent error codes in the envelope [Source: architecture/api-design-and-integration.md#error-model]

- [x] Disclaimer presentation (AC: 4)
  - [x] Append or render the standard disclaimer with assistant messages; dedupe if already present [Source: architecture/api-design-and-integration.md#disclaimers]

- [x] Contracts and DTOs
  - [x] Extend `src/server/contracts/chat.dto.ts` with streaming event types and query/headers parsing; keep existing batch DTOs intact [Source: architecture/source-tree-integration.md#proposed-structure]

- [x] Source tree and wiring
  - [x] Keep handlers thin: route → validate DTOs → call `ChatService` → stream or return envelope; no Prisma in handlers [Source: architecture/component-architecture.md#boundaries-and-responsibilities]

- [x] Testing
  - [x] Unit: `ChatService` streaming path (token accumulation, completion persistence, error mapping) with OpenAI client mocks [Source: architecture/testing-strategy.md#types-of-tests]
  - [x] UI: Chat typing indicator visibility during stream; retry flow renders and replays correctly; disclaimer is present in assistant messages [Source: architecture/testing-strategy.md#initial-tests-to-add]

## Dev Notes

### Previous Story Insights
- 3.1 introduced chat endpoints and persistence with disclaimer requirements. This story focuses on UX polish: streaming, typing indication, and robust retry without altering core contracts.

### API Specifications
- Chat endpoints: `GET/POST /api/trips/{tripId}/borderbuddy/chat/messages` support streaming or batch; include disclaimer with assistant messages [Source: architecture/api-design-and-integration.md#5-chat]
- Error model: map OpenAI/transport failures to typed codes and HTTP statuses; include `meta.timestamp` [Source: architecture/api-design-and-integration.md#error-model]
- Disclaimers: standard copy applied to assistant messages [Source: architecture/api-design-and-integration.md#disclaimers]

### LLM Behavior and Streaming
- Provider: OpenAI via `OPENAI_API_KEY`; redact sensitive inputs; enforce timeouts and retries with backoff [Source: architecture/external-api-integration.md#safety-reliability-and-cost]
- Prompt context: Trip + BorderBuddy context form inform replies; streaming when available, otherwise batch [Source: architecture/api-design-and-integration.md#llm-integration]

### Component/Service Boundaries
- Handlers remain thin; services orchestrate OpenAI and persistence; repositories isolate Prisma [Source: architecture/component-architecture.md#boundaries-and-responsibilities]
- UI updates limited to Chat pane; no global state changes required [Source: architecture/component-architecture.md#frontend-composition]

### File Locations
- Contracts: `src/server/contracts/chat.dto.ts` (extend for streaming)
- Service: `src/server/services/chat.service.ts` (add streaming support)
- API route: `src/app/api/trips/[tripId]/borderbuddy/chat/messages/route.ts` (support `Accept: text/event-stream` or `?stream=1`) [Source: architecture/source-tree-integration.md#proposed-structure]

### Technical Constraints
- AuthZ: enforce ownership on trip-scoped chat APIs [Source: architecture/api-design-and-integration.md#api-integration-strategy]
- Accessibility: typing indicator and streamed updates must be perceivable; aim for WCAG AA [Source: architecture/non-functional-nfr.md]

### Testing
- Unit: token streaming aggregation, completion persistence, backoff behavior
- UI: typing indicator toggling, SSE parsing, retry flow, disclaimer rendering [Source: architecture/testing-strategy.md]

## Testing
- Services: Mock OpenAI stream to emit `delta` chunks, verify `complete` persists final message and includes disclaimer; verify error maps to envelope codes.
- UI: Simulate streamed events to assert incremental rendering and live-region announcements; inject failure to validate Retry behavior and non-duplication of user messages.

## Project Structure Notes
- Aligns with layered structure and keeps route handlers thin; extends contracts and service only, per proposed source tree [Source: architecture/source-tree-integration.md#proposed-structure]

## Change Log
| Date       | Version | Description                                    | Author |
| ---------- | ------- | ---------------------------------------------- | ------ |
| 2025-09-14 | 0.1     | Initial draft created from Epic 3 and docs     | SM     |

## Dev Agent Record
### Agent Model Used
gpt-4o-mini (implementation), Vitest + RTL for tests

### Debug Log References

### Completion Notes List

### File List

- src/server/contracts/chat.dto.ts
- src/server/services/llm.ts
- src/server/services/chat.service.ts
- src/app/api/trips/[id]/borderbuddy/chat/messages/route.ts
- src/app/trips/[id]/chat-pane.tsx
- src/app/trips/[id]/page.tsx
- src/server/services/__tests__/chat.service.stream.test.ts
- src/app/trips/[id]/__tests__/chat-pane.test.tsx

## QA Results

### Gate Decision
- PASS: All ACs satisfied with solid tests and sensible fallbacks. Streaming via SSE is implemented with graceful completion and error handling; UI provides accessible typing indication; retry preserves user intent without duplication; disclaimer consistently applied and de‑duplicated.

### Traceability (AC → Evidence)
- AC1 Streaming: `src/app/api/trips/[id]/borderbuddy/chat/messages/route.ts` streams `{type,data}` events; `ChatService.postStream(...)` persists final assistant with disclaimer; UI consumes SSE in `chat-pane.tsx`. Unit tests: `chat.service.stream.test.ts` validates deltas → complete with disclaimer; UI test covers streaming rendering.
- AC2 Typing Indicator + A11y: Live region with `aria-live="polite" role="status"` and announcements in `chat-pane.tsx`; indicator clears on complete/error. UI test asserts indicator presence during stream.
- AC3 Retry Handling: UI shows concise error and Retry; `retry()` re-attempts without duplicating user message. Test: `chat-pane.test.tsx` validates non-duplication and success on retry. Backoff implemented in `llm.ts` and error mapping in route/service.
- AC4 Disclaimer: Prepended in `ChatService` (with de‑dupe) and persistent UI note in `chat-pane.tsx`; tests assert disclaimer presence.

### Tests Reviewed
- Service: `src/server/services/__tests__/chat.service.stream.test.ts`, `chat.service.test.ts`.
- API route: `src/app/api/trips/[id]/borderbuddy/chat/messages/__tests__/route.test.ts`.
- UI: `src/app/trips/[id]/__tests__/chat-pane.test.tsx` (streaming, error→retry, no duplication).

### NFR Validation (Advisory)
- Accessibility: Live region and clear states present; labels and controls are keyboardable. Suggest adding an explicit assertion for live-region announcements and color contrast snapshot in UI tests.
- Reliability: Backoff and timeouts in `llm.ts`; server route normalizes SSE and closes stream on `complete|error`; rate limiting guards POST spam. Looks adequate for MVP.
- Performance: SSE chunking with lightweight JSON; initial history fetch bounded; handlers remain thin. No obvious hotspots.
- Security: AuthZ enforced per trip, no secrets in payload, disclaimer reduces misinterpretation risk.

### Risks & Recommendations
- Minor: Consider a small test for dedupe logic when provider already returns disclaimer text.
- Minor: Add an integration test for non-stream fallback path including disclaimer.
- Optional: Telemetry around stream aborts/timeouts to monitor reliability in prod.

### Change Log
- 2025-09-15: QA review PASS; ACs 1–4 verified with tests; added recommendations above.
