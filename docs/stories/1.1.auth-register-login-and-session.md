Status: Ready for Review

Story
**As a** user,
**I want** to register and login,
**so that** I can access my trips

Acceptance Criteria
1) Registration validates email and password rules; login establishes a secure session.
2) Authenticated requests return user context from `/me`.
3) Unauthenticated access to protected routes is redirected to login.

Tasks / Subtasks
- [x] Backend auth foundation (AC: 1, 2)
  - [x] Add `src/server/services/auth.service.ts` with `register`, `login`, `logout`, `getCurrentUser` wired to JWT in an httpOnly cookie named `auth-token`. [Source: architecture/api-design-and-integration.md#api-integration-strategy]
  - [x] Use `jsonwebtoken` for signing/verification and `bcryptjs` for password hashing as per stack alignment. [Source: architecture/tech-stack-alignment.md#existing-technology-stack]
  - [x] Enforce verification of JWT only on the server (route handlers/services), not in middleware; rely on presence-only check in middleware if used. [Source: architecture/security-integration.md#security-integration]
  - [x] Return standardized envelopes `{ success, data?, error? }` and proper HTTP statuses (200/201/400/401). [Source: architecture/api-design-and-integration.md#api-integration-strategy]

- [x] Route handlers for auth (AC: 1, 2)
  - [x] POST `/api/auth/register` — validate email/password via Zod DTO; create user; set `auth-token` cookie. Respond 201 on success; 400 on validation; 409 if email exists. [Source: architecture/api-design-and-integration.md#api-integration-strategy]
  - [x] POST `/api/auth/login` — validate input; verify credentials; set `auth-token`; respond 200/401 accordingly. [Source: architecture/api-design-and-integration.md#api-integration-strategy]
  - [x] POST `/api/auth/logout` — clear cookie; respond 204. [Source: architecture/api-design-and-integration.md#error-model]
  - [x] GET `/api/me` — read `getCurrentUser()`; return 200 with user context when present, otherwise 401 with `{ success:false, error:{ code:"UNAUTHORIZED" } }`. [Source: architecture/api-design-and-integration.md#api-integration-strategy]

- [x] Contracts, repos, and configuration (AC: 1, 2)
  - [x] Add Zod DTOs in `src/server/contracts/auth.dto.ts` for register/login inputs and `/me` response shape. [Source: architecture/component-architecture.md#contracts-and-validation]
  - [x] Add repository `src/server/repositories/users.repo.ts` with Prisma-only accessors used by auth service. [Source: architecture/component-architecture.md#repositories]
  - [x] Ensure `src/server/config/env.ts` exposes `JWT_SECRET`; fail fast if missing. [Source: architecture/tech-stack-alignment.md#new-technology-additions]

- [x] Protected route guard (AC: 3)
  - [x] In protected layouts/pages (e.g., `src/app/(protected)/layout.tsx`), perform a server-side `getCurrentUser()` and redirect unauthenticated users to `/login`. [Source: architecture/remediation-tasks-developeractionable.md#auth-guard-posture]
  - [x] Optionally, add a minimal middleware presence-only cookie check to route unauthenticated users away from protected API paths, noting JWT cannot be fully verified in Edge. [Source: architecture/existing-project-analysis.md#identified-constraints]

- [x] Frontend forms (AC: 1, 3)
  - [x] Create `src/app/register/page.tsx` and `src/app/login/page.tsx` with basic forms; client-side validate fields, then call respective API routes. [Source: architecture/coding-standards-and-conventions.md#coding-standards-and-conventions]
  - [x] After successful login/register, route to the authenticated landing (e.g., `/trips`). On failure, show accessible error messages. [Source: architecture/component-architecture.md#frontend-composition]

- [ ] Testing (AC: 1, 2, 3)
  - [x] Unit test `auth.service.ts` happy paths and error cases with repo mocks. [Source: architecture/testing-strategy.md#testing-strategy]
  - [x] Route handler tests ensuring envelope + status codes for `/api/auth/login` and `/api/me`. [Source: architecture/testing-strategy.md#testing-strategy]
  - [x] UI tests for login form validation and redirect behavior post-auth. [Source: architecture/testing-strategy.md#testing-strategy]

Dev Agent Record

- Agent Model Used: James (dev)
- Debug Log References:
  - Added Vitest configuration `vitest.config.ts` and setup `vitest.setup.ts` with `@testing-library/jest-dom`.
  - Implemented unit tests for AuthService with mocks of `UsersRepo`, `bcryptjs`, `jsonwebtoken`, and `next/headers` cookies.
  - Implemented route handler tests for `/api/auth/login` and `/api/me`, asserting envelope, status codes, and `Set-Cookie` on success.
  - Added UI tests for Login and Register pages covering client-side validation, API error handling, and redirect to `/trips` on success.
  - Verified locally: all tests pass via `npm run test` (Vitest + RTL). CI wiring to be handled separately.

- Completion Notes:
  - Established baseline testing stack (Vitest + RTL scaffold) aligned with Tech Stack Alignment.
  - Added AuthService unit tests covering register duplicate/happy, login success/invalid, and `getCurrentUser` happy path.
  - Added route tests covering validation error (400), invalid credentials (401), and success flow (200 + Set-Cookie) for login; and 401/200 paths for `/api/me`.
  - Added UI tests for login/register validation and post-auth redirect to `/trips`; verified all tests pass locally.
  - Standardized post-auth landing path to `/trips` in specs; code alignment to `/trips` recommended where needed.
  - Rate limiting/brute-force protection not introduced in this story; to be addressed before production per QA note.

- File List:
  - M package.json
  - A vitest.config.ts
  - A vitest.setup.ts
  - A src/server/services/__tests__/auth.service.test.ts
  - A src/app/api/auth/login/__tests__/route.test.ts
  - A src/app/api/me/__tests__/route.test.ts
  - A src/app/login/__tests__/page.test.tsx
  - A src/app/register/__tests__/page.test.tsx

Change Log

- 2025-09-10: Add Vitest setup and auth tests; update status to Ready for Review; partial closure of QA TEST-001. Pending: UI tests and package installation/CI execution.
- 2025-09-10: Add UI tests for login/register validation and redirect; all tests pass locally. Requesting QA re-review.

Dev Notes

- Previous Story Insights
  - No prior `1.x` stories exist; baseline environment and envelope setup may be covered by TT-001/TT-004 drafts but are not prerequisites for drafting this story.

- Data Models
  - User model exists; epic requires authenticated user context via `/me`. Architecture notes a possible addition `nationality` and that Trip includes `purpose`. Specific auth fields are not detailed. [Source: architecture/data-models-and-schema-changes.md#updates-to-existing-models]

- API Specifications
  - Authentication uses a JWT in an httpOnly cookie named `auth-token`. Handlers must read `getCurrentUser()` and return 401 if absent. [Source: architecture/api-design-and-integration.md#api-integration-strategy]
  - Standard response envelope `{ success, data?, error? }` with correct status codes. [Source: architecture/api-design-and-integration.md#api-integration-strategy]
  - Error codes include `UNAUTHORIZED` for missing/invalid session. [Source: architecture/api-design-and-integration.md#error-model]

- Security Constraints
  - Verify JWT on server in route handlers; do not rely on Edge middleware for verification. Authorization checks happen in services/repos. [Source: architecture/security-integration.md#security-integration]

- Tech Stack
  - Next.js 15 (App Router), TypeScript, Prisma (PostgreSQL), Zod, jsonwebtoken, bcryptjs; Turbopack; ESLint. [Source: architecture/tech-stack-alignment.md#existing-technology-stack]

- Component Specifications
  - Use simple login/register pages under `src/app/*`; post to API routes; on success navigate to `/trips`. Keep UI accessible and aligned with shadcn/ui patterns. [Source: architecture/component-architecture.md#frontend-composition]

- File Locations
  - Services in `src/server/services/*`; repositories in `src/server/repositories/*`; contracts in `src/server/contracts/*`; route handlers in `src/app/api/*`; cross-cutting in `src/server/config/*` and `src/lib/*`. [Source: architecture/source-tree-integration.md#proposed-structure]

- Testing Requirements
  - Add Vitest + RTL; co-locate tests with source; target ≥80% for services. Include service unit tests, route handler integration tests, and UI validation tests. [Source: architecture/testing-strategy.md#testing-strategy]

- Project Structure Notes
  - Ensure separation of concerns: route handlers → services → repositories. Services never import `next/*`; repositories do not include business logic. [Source: architecture/component-architecture.md#boundaries-and-responsibilities]

Change Log
| Date       | Version | Description                 | Author |
|------------|---------|-----------------------------|--------|
| 2025-09-09 | 0.1     | Initial draft created       | SM     |

Dev Agent Record
- Agent Model Used: Codex Dev (Full Stack)
- Debug Log References: Verified JWT cookie flow, Zod DTOs, and server-only verification in `src/server/services/auth.service.ts`, `src/app/api/auth/*`, `src/app/api/me/route.ts`, `src/middleware.ts`, and UI flows in `src/app/login/page.tsx`, `src/app/register/page.tsx`.
- Completion Notes List:
  - Implemented endpoints exist and return standardized envelopes; cookies set as httpOnly `auth-token` with correct attributes.
  - Frontend forms validate via Zod, call `/api/auth/*`, and redirect to the authenticated landing (`/trips`).
  - Protected routing enforced via server redirect and presence-only middleware; `/api/me` returns 401 when unauthenticated.
  - Remaining gap: tests are not yet set up (Vitest/RTL); all testing tasks left unchecked.
- File List:
  - src/server/services/auth.service.ts
  - src/server/contracts/auth.dto.ts
  - src/server/repositories/users.repo.ts
  - src/server/config/env.ts
  - src/app/api/auth/register/route.ts
  - src/app/api/auth/login/route.ts
  - src/app/api/auth/logout/route.ts
  - src/app/api/me/route.ts
  - src/lib/auth.ts
  - src/middleware.ts
  - src/app/login/page.tsx
  - src/app/register/page.tsx
  - src/app/(protected)/layout.tsx
  - src/app/trips/page.tsx (authenticated landing/list, replacing prior dashboard reference in specs)

QA Results

- Summary: Functional implementation satisfies AC 1–3 across services, routes, middleware, and protected layout. Unit, route-handler, and UI tests are present. Landing path standardized to `/trips` in specs.
- Evidence: Verified `register`, `login`, `logout`, `getCurrentUser` in `src/server/services/auth.service.ts`; Zod DTOs in `src/server/contracts/auth.dto.ts`; repository accessors in `src/server/repositories/users.repo.ts`; route handlers for `/api/auth/*` and `/api/me`; presence-only middleware guard; server-side redirect in `(protected)/layout.tsx`; UI forms in `/login` and `/register`. Found tests at:
  - `src/server/services/__tests__/auth.service.test.ts`
  - `src/app/api/auth/login/__tests__/route.test.ts`
  - `src/app/api/me/__tests__/route.test.ts`
  - `src/app/login/__tests__/page.test.tsx`
  - `src/app/register/__tests__/page.test.tsx`
- Security posture: httpOnly cookie `auth-token` set with `sameSite:lax`, `secure` in production, `maxAge:7d`; JWT verified server-side only; logout clears cookie. Rate limiting/brute-force protection is recommended for production (not in current AC scope).
- NFRs: Performance and reliability acceptable for MVP; fail-fast on `JWT_SECRET` via `src/server/config/env.ts`. Observability minimal; consider structured logging later.
- Decision: Gate = PASS. Tests cover services, API handlers, and UI flows; functionality aligns with acceptance criteria. Note resolved: specs standardized on `/trips` as the authenticated landing.

Requirements Traceability (Given-When-Then)
- AC1 Registration/Login + session
  - Given a valid email and strong password, When POST `/api/auth/register` with valid payload, Then respond 201 with `{ success:true, data.user }` and set httpOnly `auth-token` cookie.
  - Given valid credentials, When POST `/api/auth/login`, Then respond 200 with `{ success:true, data.user }` and set cookie; invalid creds → 401 `{ success:false, error:{ code:"INVALID_CREDENTIALS" } }`.
- AC2 `/me` returns user context
  - Given a valid `auth-token`, When GET `/api/me`, Then respond 200 with `{ success:true, data:{ user } }` containing id/email/fullName.
  - Given no/invalid token, When GET `/api/me`, Then respond 401 with `{ success:false, error:{ code:"UNAUTHORIZED" } }`.
- AC3 Protected routes redirect unauthenticated users
  - Given no valid session, When navigating to a protected page under `(protected)` or `/trips`, Then server-side redirect to `/login`; middleware presence-only check also redirects.

Test Design Recommendations
- Unit: AuthService `register` happy/duplicate, `login` success/invalid, `getCurrentUser` token valid/invalid/absent.
- Integration: Route handlers for `/api/auth/login`, `/api/auth/register`, and `/api/me` validate envelopes + HTTP statuses and cookie behavior.
- E2E/UI: Form validation errors, successful submit sets cookie and lands on authenticated page; unauthenticated access to protected routes redirects.

Risks & Follow-ups
- TEST-001 (medium): No automated tests; add Vitest + RTL per Testing Requirements with ≥80% service coverage.
- SEC-001 (medium): No rate limiting/brute-force protection on login; consider middleware (e.g., simple in-memory or upstream) before production.
- UX-001 (low): Align post-auth landing path consistently (specs use `/trips`).

Update 2025-09-10 (QA):
- Clarification: Automated tests are present (unit, route, and UI) as listed above; prior note "No automated tests" is outdated. Maintain Vitest + RTL going forward with ≥80% service coverage target.
- Decision reaffirmed: Gate = PASS. Implementation aligns with AC 1–3 and uses secure httpOnly cookie session with server-only JWT verification.
- Open follow-ups: SEC-001 (rate limiting before prod).
